# Name of your application. Used to uniquely configure containers.
service: maquina-components-demo

# Docker image registry
image: maquina-app/maquina-components-demo

ssh:
  user: zzyzx
  port: 4422

# Deploy to these servers
servers:
  web:
    hosts:
      - 192.168.1.128
    options:
      # Mount persistent storage for SQLite database
      volume:
        - maquina-components-demo_storage:/rails/test/dummy/storage

# Kamal proxy configuration (replaces Traefik in Kamal 2.x)
proxy:
  ssl: false
  host: demo.maquina.app
  app_port: 80
  # Health check configuration
  healthcheck:
    interval: 3
    path: /up
    timeout: 60

# Docker registry credentials
registry:
  server: ghcr.io
  username: maquina-app
  password:
    - KAMAL_REGISTRY_PASSWORD

# Docker build configuration
builder:
  # Build from project root to include the engine
  context: .
  dockerfile: test/dummy/Dockerfile
  # Multiplatform builds (optional, uncomment for ARM support)
  # multiarch: false
  arch: amd64
  #   - amd64
  #   - arm64

# Environment variables
env:
  # Secret environment variables (loaded from .kamal/secrets)
  secret:
    - RAILS_MASTER_KEY
  # Clear environment variables
  clear:
    RAILS_LOG_TO_STDOUT: "true"
    RAILS_SERVE_STATIC_FILES: "true"
    SOLID_QUEUE_IN_PUMA: false

# Asset bridging for zero-downtime deploys
# Keeps old assets available during deployment
asset_path: /rails/test/dummy/public/assets

# Aliases for common commands
aliases:
  console: app exec --interactive --reuse "bin/rails console"
  shell: app exec --interactive --reuse "bash"
  logs: app logs -f
  dbc: app exec --interactive --reuse "bin/rails dbconsole"
